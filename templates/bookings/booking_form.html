{% extends "base.html" %}
{% block title %}Book: {{ service.name }}{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="mb-1">Book now: {{ service.name }}</h3>
          <p class="text-muted">Price per day: <strong>{{ service.price }} €</strong></p>

          {% if messages %}
            {% for m in messages %}
              <div class="alert alert-{{ m.tags|default:"info" }} mb-3">{{ m }}</div>
            {% endfor %}
          {% endif %}

          <form method="post" action="{% url 'booking_form' service.pk %}" id="bookingForm" data-price="{{ service.price }}">
            {% csrf_token %}
          {% if booked_ranges %}
            <hr>
			<div class="mb-3">
            <p class="small text-muted mb-1">Already booked:</p>
            <ul class="small text-muted mb-0">
              {% for b in booked_ranges %}
                <li>{{ b.start_date|date:"d.m.Y" }} – {{ b.end_date|date:"d.m.Y" }}</li>
              {% empty %}
                <li>None</li>
              {% endfor %}
            </ul>
			</div>
          {% endif %}
            <div class="row g-3">
              <div class="col-md-6">
                <label for="id_start_date" class="form-label">Start date</label>
                <input type="date" name="start_date" id="id_start_date" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label for="id_end_date" class="form-label">End date</label>
                <input type="date" name="end_date" id="id_end_date" class="form-control" required>
              </div>
            </div>

            <div class="booking-summary mt-4">
              <h6 class="mb-3">Summary</h6>
              <div class="d-flex justify-content-between mb-2">
                <span>Total days</span>
                <span id="summaryDays">-</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Price per day</span>
                <span id="summaryPricePerDay">{{ service.price }} €</span>
              </div>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total</span>
                <span id="summaryTotal">-</span>
              </div>
            </div>

            <hr class="my-4">

            <h6 class="mb-3">Payment method</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="pm_card" value="card" checked>
                  <label class="form-check-label" for="pm_card">Credit / Debit Card</label>
                </div>
                <div id="cardFields" class="mt-2">
                  <input type="text" class="form-control mb-2" name="card_name" placeholder="Name on card">
                  <input type="text" class="form-control mb-2" name="card_number" placeholder="Card number">
                  <div class="row g-2">
                    <div class="col">
                      <input type="text" class="form-control" name="card_exp" placeholder="MM/YY">
                    </div>
                    <div class="col">
                      <input type="text" class="form-control" name="card_cvc" placeholder="CVC">
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="payment_method" id="pm_paypal" value="paypal">
                  <label class="form-check-label" for="pm_paypal">PayPal</label>
                </div>
                <div id="paypalNote" class="mt-2 d-none">
                  <input type="email" class="form-control" name="paypal_email" placeholder="PayPal email">
                </div>
              </div>
            </div>

            <div class="mt-4 text-end">
              <button type="submit" class="btn btn-primary" id="submitBtn">Pay & Book</button>
            </div>
          </form>


        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById('bookingForm');
  if (!form) return;

  const price = parseFloat(String(form.dataset.price).replace(',', '.')) || 0;
  const startInput = document.getElementById('id_start_date');
  const endInput   = document.getElementById('id_end_date');
  const daysEl  = document.getElementById('summaryDays');
  const totalEl = document.getElementById('summaryTotal');

  const pmCard   = document.getElementById('pm_card');
  const pmPaypal = document.getElementById('pm_paypal');
  const cardBox  = document.getElementById('cardFields');
  const ppNote   = document.getElementById('paypalNote');

  // Min = today
  const today = new Date().toISOString().slice(0, 10);
  startInput.min = today;
  endInput.min = today;

  function update() {
    const sVal = startInput.value;
    const eVal = endInput.value;
    if (!sVal || !eVal) {
      daysEl.textContent = '-';
      totalEl.textContent = '-';
      return;
    }
    const s = new Date(sVal);
    const e = new Date(eVal);
    if (e >= s) {
      const ms = e - s;
      const days = Math.floor(ms / 86400000) + 1; // inclusive
      daysEl.textContent = days;
      totalEl.textContent = (days * price).toFixed(2) + ' €';
    } else {
      daysEl.textContent = '-';
      totalEl.textContent = '-';
    }
  }

  function togglePayment() {
    const useCard = pmCard.checked;
    cardBox.classList.toggle('d-none', !useCard);
    ppNote.classList.toggle('d-none', useCard);
  }

  startInput.addEventListener('input', update);
  endInput.addEventListener('input', update);
  pmCard.addEventListener('change', togglePayment);
  pmPaypal.addEventListener('change', togglePayment);

  togglePayment();
  update();
})();
</script>
{% endblock %}
